<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Access Control Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #fff; border-bottom: 2px solid #0d6efd; font-weight: bold; padding: 1rem; }
        .btn-action { margin-right: 5px; }
        .status-badge { font-size: 0.8em; }
        
        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        /* Loading Spinner Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.active {
            display: flex;
        }
        
        /* Better badge styling */
        .access-badge {
            cursor: pointer;
            transition: all 0.2s;
            margin: 2px;
        }
        .access-badge:hover {
            opacity: 0.7;
            transform: scale(1.05);
        }
        
        /* Checkbox list styling */
        .room-checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        
        .form-check {
            padding: 0.5rem;
        }
        
        .form-check:hover {
            background-color: #f8f9fa;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        
        /* Card Scanner Styling */
        .scanner-input {
            font-size: 1.5rem;
            font-family: monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 3px solid #0d6efd;
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.3);
        }
        
        .scanner-input:focus {
            box-shadow: 0 0 20px rgba(13, 110, 253, 0.5);
            border-color: #0a58ca;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
            100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
        }
        
        .card-info-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .card-new-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<nav class="navbar navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1"><i class="fa-solid fa-door-open"></i> IoT Access Control System</span>
        <button class="btn btn-light btn-sm" onclick="refreshAll()">
            <i class="fa-solid fa-refresh"></i> Refresh All
        </button>
    </div>
</nav>

<div class="container">
    
    <!-- CARD SCANNER SECTION -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fa-solid fa-scanner"></i> RFID Card Scanner
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fa-solid fa-id-card fa-3x text-primary pulse"></i>
                    </div>
                    <h5>Scan or Enter Card UID</h5>
                    <form id="scanCardForm" class="mt-3">
                        <div class="row justify-content-center">
                            <div class="col-md-6">
                                <input 
                                    type="text" 
                                    class="form-control scanner-input text-center" 
                                    id="scanCardInput" 
                                    placeholder="Scan card or type UID..." 
                                    autocomplete="off"
                                    autofocus>
                                <div class="form-text">Press Enter after scanning or typing</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 1: ROOMS MANAGEMENT -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-building"></i> Room Management</span>
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addRoomModal">
                        <i class="fa-solid fa-plus"></i> Add Room
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Room Name</th>
                                    <th>Door Controls</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="roomTableBody">
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- COL 1: RFID CARDS -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fa-solid fa-id-card"></i> RFID Cards</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Card UID</th>
                                    <th>Owner Name</th>
                                    <th>Access Permissions</th>
                                </tr>
                            </thead>
                            <tbody id="cardTableBody">
                                <tr>
                                    <td colspan="3" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- COL 2: QR GENERATOR -->
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-qrcode"></i> QR Session Generator
                </div>
                <div class="card-body">
                    <form id="qrForm">
                        <div class="mb-3">
                            <label class="form-label">Select Room</label>
                            <select class="form-select" id="qrRoomSelect" required>
                                <option value="" selected disabled>Choose a room...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Duration (Minutes)</label>
                            <input type="number" class="form-control" id="qrDuration" value="60" min="1" max="1440">
                            <div class="form-text">Maximum 24 hours (1440 minutes)</div>
                        </div>
                        <button type="submit" class="btn btn-dark w-100">
                            <i class="fa-solid fa-qrcode"></i> Generate QR Token
                        </button>
                    </form>
                    <div id="qrResult" class="mt-3 p-3 bg-light border rounded d-none text-center">
                        <p class="mb-1 text-muted small">Token ID:</p>
                        <h6 id="qrTokenDisplay" class="text-break font-monospace text-primary mb-2"></h6>
                        <small id="qrTimeDisplay" class="text-danger d-block mb-2"></small>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToken()">
                            <i class="fa-solid fa-copy"></i> Copy Token
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Sessions List -->
            <div class="card">
                <div class="card-header">
                    <i class="fa-solid fa-clock"></i> Active Sessions
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="sessionList">
                        <li class="list-group-item text-center text-muted">
                            <small>No sessions yet</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Add Room -->
<div class="modal fade" id="addRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-building"></i> Add New Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRoomForm">
                    <div class="mb-3">
                        <label class="form-label">Room ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newRoomId" placeholder="e.g., 101" required>
                        <div class="form-text">Unique identifier for the room</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Room Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newRoomName" placeholder="e.g., Lab 1" required>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-save"></i> Save Room
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Card Management Menu (After Scanning) -->
<div class="modal fade" id="cardManagementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-id-card"></i> Card Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cardManagementBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- APP LOGIC -->
<script>
    // ===== GLOBAL STATE =====
    let allRooms = [];
    let currentScannedCard = null;
    
    // ===== UTILITY FUNCTIONS =====
    
    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }
    
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast_' + Date.now();
        
        const bgColor = {
            'success': 'bg-success',
            'error': 'bg-danger',
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-secondary';
        
        const icon = {
            'success': 'fa-check-circle',
            'error': 'fa-exclamation-circle',
            'warning': 'fa-exclamation-triangle',
            'info': 'fa-info-circle'
        }[type] || 'fa-info-circle';
        
        const toastHTML = `
            <div class="toast align-items-center text-white ${bgColor} border-0" role="alert" id="${toastId}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fa-solid ${icon} me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
        
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }
    
    async function apiCall(url, options = {}) {
        try {
            const response = await fetch(url, options);
            const isJson = response.headers.get('content-type')?.includes('application/json');
            const data = isJson ? await response.json() : await response.text();
            
            if (!response.ok) {
                throw new Error(data.error || data || 'Request failed');
            }
            
            return data;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }
    
    // ===== DATA LOADING =====
    
    document.addEventListener('DOMContentLoaded', () => {
        loadRooms();
        loadCards();
        loadSessions();
        
        // Focus on scanner input
        document.getElementById('scanCardInput').focus();
    });
    
    function refreshAll() {
        showToast('Refreshing data...', 'info');
        loadRooms();
        loadCards();
        loadSessions();
    }
    
    async function loadRooms() {
        try {
            const rooms = await apiCall('/api/rooms');
            allRooms = rooms; // Store globally
            
            const tbody = document.getElementById('roomTableBody');
            const selectQr = document.getElementById('qrRoomSelect');
            
            if (rooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><i class="fa-solid fa-inbox"></i><br>No rooms added yet</td></tr>';
            } else {
                tbody.innerHTML = '';
            }
            
            selectQr.innerHTML = '<option value="" disabled selected>Choose a room...</option>';
            
            rooms.forEach(room => {
                // Populate Table
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${room.id}</strong></td>
                        <td>${room.roomname}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-success" onclick="controlDoor('${room.id}', 'OPEN')">
                                <i class="fa-solid fa-lock-open"></i> Open
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoom('${room.id}')" title="Delete Room">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                // Populate Dropdowns
                const option = `<option value="${room.id}">${room.roomname} (${room.id})</option>`;
                selectQr.innerHTML += option;
            });
            
        } catch (error) {
            showToast('Failed to load rooms: ' + error.message, 'error');
        }
    }
    
    async function loadCards() {
        try {
            const cards = await apiCall('/api/cards');
            
            const tbody = document.getElementById('cardTableBody');
            
            if (cards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state"><i class="fa-solid fa-id-card"></i><br>No cards registered yet</td></tr>';
            } else {
                tbody.innerHTML = '';
            }
            
            cards.forEach(card => {
                // Format access rooms as badges
                let accessBadges = '<span class="text-muted small"><i>No access granted</i></span>';
                if(card.access_rooms) {
                    accessBadges = card.access_rooms.split(',').map(r => 
                        `<span class="badge bg-info text-dark me-1">${r}</span>`
                    ).join(' ');
                }
                
                tbody.innerHTML += `
                    <tr style="cursor: pointer;" onclick="scanAndShowCard('${card.uid}')">
                        <td class="font-monospace"><strong>${card.uid}</strong></td>
                        <td>${card.cardname}</td>
                        <td>${accessBadges}</td>
                    </tr>
                `;
            });
            
        } catch (error) {
            showToast('Failed to load cards: ' + error.message, 'error');
        }
    }
    
    async function loadSessions() {
        try {
            const sessions = await apiCall('/api/sessions');
            const list = document.getElementById('sessionList');
            
            if (sessions.length === 0) {
                list.innerHTML = '<li class="list-group-item text-center text-muted"><small>No sessions created yet</small></li>';
                return;
            }
            
            list.innerHTML = '';
            sessions.slice(0, 10).forEach(s => {
                const now = new Date();
                const end = new Date(s.endtime);
                const start = new Date(s.starttime);
                const isActive = now >= start && now < end;
                const isPending = now < start;
                
                let statusBadge = '';
                let statusClass = '';
                
                if (isActive) {
                    statusBadge = 'Active';
                    statusClass = 'bg-success';
                } else if (isPending) {
                    statusBadge = 'Pending';
                    statusClass = 'bg-warning';
                } else {
                    statusBadge = 'Expired';
                    statusClass = 'bg-secondary';
                }
                
                list.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="fw-bold">Room ${s.room_id}</div>
                            <small class="text-muted font-monospace d-block" style="font-size:0.7em">${s.id}</small>
                            <small class="text-muted">${start.toLocaleString()} - ${end.toLocaleString()}</small>
                        </div>
                        <span class="badge ${statusClass} rounded-pill">${statusBadge}</span>
                    </li>
                `;
            });
        } catch (error) {
            showToast('Failed to load sessions: ' + error.message, 'error');
        }
    }
    
    // ===== CARD SCANNER LOGIC =====
    
    document.getElementById('scanCardForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const uid = document.getElementById('scanCardInput').value.trim().toUpperCase();
        
        if (!uid) {
            showToast('Please enter a card UID', 'warning');
            return;
        }
        
        await handleScannedCard(uid);
        
        // Clear input and refocus
        document.getElementById('scanCardInput').value = '';
        document.getElementById('scanCardInput').focus();
    });
    
    // Function to handle clicked card from table
    function scanAndShowCard(uid) {
        handleScannedCard(uid);
    }
    
    async function handleScannedCard(uid) {
        showLoading();
        try {
            // Fetch card info
            const cards = await apiCall('/api/cards');
            const card = cards.find(c => c.uid === uid);
            
            currentScannedCard = { uid, exists: !!card, data: card };
            
            if (card) {
                showExistingCardMenu(card);
            } else {
                showNewCardMenu(uid);
            }
            
        } catch (error) {
            showToast('Error loading card: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    function showNewCardMenu(uid) {
        const modalBody = document.getElementById('cardManagementBody');
        
        modalBody.innerHTML = `
            <div class="card-new-panel">
                <h4><i class="fa-solid fa-circle-plus"></i> New Card Detected</h4>
                <p class="mb-0 font-monospace fs-5">${uid}</p>
            </div>
            
            <div class="alert alert-info">
                <i class="fa-solid fa-info-circle"></i> This card is not registered in the system.
            </div>
            
            <form id="quickAddCardForm">
                <div class="mb-3">
                    <label class="form-label">Owner Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="quickCardName" placeholder="Enter owner name" required autofocus>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fa-solid fa-door-open"></i> Grant Access to Rooms (Optional)
                    </label>
                    <div class="room-checkbox-list" id="quickRoomList">
                        ${allRooms.map(room => `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${room.id}" id="quick_room_${room.id}">
                                <label class="form-check-label" for="quick_room_${room.id}">
                                    ${room.roomname} <small class="text-muted">(${room.id})</small>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fa-solid fa-plus-circle"></i> Add This Card
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        `;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('cardManagementModal'));
        modal.show();
        
        // Handle form submission
        document.getElementById('quickAddCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addCardFromScan();
        });
    }
    
    function showExistingCardMenu(card) {
        const modalBody = document.getElementById('cardManagementBody');
        
        const accessRooms = card.access_rooms ? card.access_rooms.split(',') : [];
        
        modalBody.innerHTML = `
            <div class="card-info-panel">
                <h4><i class="fa-solid fa-id-card"></i> ${card.cardname}</h4>
                <p class="mb-0 font-monospace fs-5">${card.uid}</p>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6><i class="fa-solid fa-check-circle text-success"></i> Current Access</h6>
                    <div class="border rounded p-2" style="min-height: 100px; max-height: 200px; overflow-y: auto;">
                        ${accessRooms.length > 0 ? 
                            accessRooms.map(roomId => {
                                const room = allRooms.find(r => r.id === roomId);
                                return `
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>
                                            <i class="fa-solid fa-door-open text-success"></i> 
                                            ${room ? room.roomname : roomId}
                                        </span>
                                        <button class="btn btn-sm btn-outline-danger" onclick="quickRevokeAccess('${card.uid}', '${roomId}')">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                `;
                            }).join('') 
                            : '<p class="text-muted text-center mt-3">No access granted</p>'
                        }
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6><i class="fa-solid fa-plus-circle text-primary"></i> Add Room Access</h6>
                    <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                        ${allRooms.filter(room => !accessRooms.includes(room.id)).map(room => `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>
                                    <i class="fa-solid fa-door-closed text-muted"></i> 
                                    ${room.roomname}
                                </span>
                                <button class="btn btn-sm btn-outline-success" onclick="quickGrantAccess('${card.uid}', '${room.id}')">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <hr>
            
            <div class="d-flex gap-2">
                <button class="btn btn-danger" onclick="confirmDeleteCard('${card.uid}', '${card.cardname}')">
                    <i class="fa-solid fa-trash"></i> Delete Card
                </button>
                <button class="btn btn-secondary ms-auto" data-bs-dismiss="modal">Close</button>
            </div>
        `;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('cardManagementModal'));
        modal.show();
    }
    
    // ===== QUICK ACTIONS FROM MODAL =====
    
    async function addCardFromScan() {
        const uid = currentScannedCard.uid;
        const cardname = document.getElementById('quickCardName').value.trim();
        const selectedRooms = Array.from(document.querySelectorAll('#quickRoomList input:checked'))
            .map(cb => cb.value);
        
        showLoading();
        try {
            // Create card
            await apiCall('/api/cards', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid, cardname })
            });
            
            // Grant access to selected rooms
            for (const room_id of selectedRooms) {
                try {
                    await apiCall('/api/cards/access', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ uid, room_id })
                    });
                } catch (err) {
                    console.error(`Failed to grant access to room ${room_id}:`, err);
                }
            }
            
            showToast(`Card "${cardname}" added successfully!`, 'success');
            
            // Close modal and reload
            const modal = bootstrap.Modal.getInstance(document.getElementById('cardManagementModal'));
            modal.hide();
            loadCards();
            
        } catch (error) {
            showToast('Failed to add card: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    async function quickGrantAccess(uid, room_id) {
        showLoading();
        try {
            await apiCall('/api/cards/access', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid, room_id })
            });
            
            showToast(`Access granted to room ${room_id}!`, 'success');
            
            // Reload card info
            await handleScannedCard(uid);
            loadCards();
            
        } catch (error) {
            showToast('Failed to grant access: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    async function quickRevokeAccess(uid, room_id) {
        showLoading();
        try {
            await apiCall('/api/cards/access', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid, room_id })
            });
            
            showToast(`Access revoked for room ${room_id}!`, 'success');
            
            // Reload card info
            await handleScannedCard(uid);
            loadCards();
            
        } catch (error) {
            showToast('Failed to revoke access: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    function confirmDeleteCard(uid, cardname) {
        if(!confirm(`Are you sure you want to delete card "${cardname}" (${uid})?\n\nThis will also remove all access permissions.`)) return;
        deleteCardFromModal(uid);
    }
    
    async function deleteCardFromModal(uid) {
        showLoading();
        try {
            await apiCall(`/api/cards/${uid}`, { method: 'DELETE' });
            showToast(`Card deleted successfully!`, 'success');
            
            // Close modal and reload
            const modal = bootstrap.Modal.getInstance(document.getElementById('cardManagementModal'));
            modal.hide();
            loadCards();
            
        } catch (error) {
            showToast('Failed to delete card: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    // ===== OTHER ACTIONS =====
    
    // Create Room
    document.getElementById('addRoomForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('newRoomId').value.trim();
        const roomname = document.getElementById('newRoomName').value.trim();
        
        showLoading();
        try {
            await apiCall('/api/rooms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, roomname })
            });
            
            showToast(`Room "${roomname}" created successfully!`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addRoomModal'));
            modal.hide();
            e.target.reset();
            loadRooms();
        } catch (error) {
            showToast('Failed to create room: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    });
    
    // Delete Room
    async function deleteRoom(id) {
        if(!confirm(`Are you sure you want to delete room "${id}"?\n\nThis will fail if access logs exist for this room.`)) return;
        
        showLoading();
        try {
            await apiCall(`/api/rooms/${id}`, { method: 'DELETE' });
            showToast(`Room "${id}" deleted successfully!`, 'success');
            loadRooms();
        } catch (error) {
            showToast('Failed to delete room: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    // Generate QR
    document.getElementById('qrForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const room_id = document.getElementById('qrRoomSelect').value;
        const duration_minutes = document.getElementById('qrDuration').value;
        
        showLoading();
        try {
            const data = await apiCall('/api/sessions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room_id, duration_minutes })
            });
            
            // Show Result
            const resultDiv = document.getElementById('qrResult');
            resultDiv.classList.remove('d-none');
            document.getElementById('qrTokenDisplay').innerText = data.qr_code;
            document.getElementById('qrTimeDisplay').innerText = `Valid until: ${new Date(data.valid_until).toLocaleString()}`;
            
            window.currentToken = data.qr_code;
            
            showToast('QR token generated successfully!', 'success');
            loadSessions();
        } catch (error) {
            showToast('Failed to generate QR token: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    });
    
    // Copy Token
    function copyToken() {
        const token = window.currentToken || document.getElementById('qrTokenDisplay').innerText;
        navigator.clipboard.writeText(token).then(() => {
            showToast('Token copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Failed to copy token', 'error');
        });
    }
    
    // Door Control
    async function controlDoor(room, action) {
        const endpoint = action === 'OPEN' ? '/open-door' : '/close-door';
        showLoading();
        try {
            const response = await apiCall(`${endpoint}?room=${room}&source=CONSOLE`);
            showToast(`Door ${action.toLowerCase()}ed for room ${room}`, 'success');
        } catch (error) {
            showToast('Failed to control door: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    // Refocus scanner input when modal closes
    document.getElementById('cardManagementModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('scanCardInput').focus();
    });
</script>

</body>
</html>